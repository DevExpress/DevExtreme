<template>
  <div class="images">
    <div
      v-for="house in houses"
      :key="house.ID"
    >
      <div
        class="item-content"
        @click="showHouse(house)"
      >
        <img
          :alt="house.Address"
          :src="house.Image"
        >
        <div class="item-options">
          <div>
            <div class="address">{{ house.Address }}</div>
            <div class="price large-text">{{ currency(house.Price) }}</div>
            <div class="agent">
              <div :id="'house' + house.ID">
                <img
                  alt="Listing agent"
                  :src="'../../../../images/icon-agent.svg'"
                >
                Listing agent
              </div>
            </div>
          </div>
        </div>
        <DxPopover
          :position="position"
          :target="'#house' + house.ID"
          :width="260"
          show-event="mouseenter"
          hide-event="mouseleave"
          content-template="popoverContent"
        >
          <template #popoverContent="{ data }">
            <div class="agent-details">
              <img
                :alt="house.Agent.Name"
                :src="house.Agent.Picture"
              >
              <div>
                <div class="name large-text">{{ house.Agent.Name }}</div>
                <div class="phone">Tel: {{ house.Agent.Phone }}</div>
              </div>
            </div>
          </template>
        </DxPopover>
      </div>
    </div>

    <DxPopup
      :width="660"
      :height="540"
      :show-title="true"
      :title="currentHouse.Address"
      :drag-enabled="false"
      :hide-on-outside-click="true"
      v-model:visible="popupVisible"
      :show-close-button="true"
    >
      <template #content="{ data }">
        <div class="popup-property-details">
          <div class="large-text">{{ currency(currentHouse.Price) }}</div>
          <div class="opacity">
            {{ currentHouse.Address }},
            {{ currentHouse.City }},
            {{ currentHouse.State }}
          </div>
          <DxButton
            :text="favoriteText"
            :width="260"
            :height="44"
            class="favorites"
            icon="favorites"
            @click="changeFavoriteState"
          />
          <div class="images">
            <img
              :alt="currentHouse.Address"
              :src="currentHouse.Image"
            >
            <img
              :alt="currentHouse.Address"
              :src="currentHouse.Image.replace('.jpg', 'b.jpg')"
            >
          </div>
          <div>{{ currentHouse.Features }}</div>
        </div>
      </template>
    </DxPopup>
  </div>

</template>
<script setup lang="ts">
import { computed, ref } from 'vue';
import DxButton from 'devextreme-vue/button';
import DxPopup from 'devextreme-vue/popup';
import DxPopover from 'devextreme-vue/popover';
import notify from 'devextreme/ui/notify';
import { housesSource } from './data.ts';

const ADD_TO_FAVORITES = 'Add to Favorites';
const REMOVE_FROM_FAVORITES = 'Remove from Favorites';
const houses = ref(housesSource);
const currentHouse = ref(housesSource[0]);
const popupVisible = ref(false);
const position = {
  offset: '0, 2',
  at: 'bottom',
  my: 'top',
  collision: 'fit flip',
};

const favoriteText = computed(
  () => (currentHouse.value.Favorite ? REMOVE_FROM_FAVORITES : ADD_TO_FAVORITES),
);

const currencyFormatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  minimumFractionDigits: 0,
  maximumFractionDigits: 2,
});
const currency = (val) => currencyFormatter.format(val);
function showHouse(house) {
  currentHouse.value = house;
  popupVisible.value = true;
}
function changeFavoriteState() {
  const favoriteState = !currentHouse.value.Favorite;
  const message = `This item has been ${
    favoriteState ? 'added to' : 'removed from'
  } the Favorites list!`;
  currentHouse.value.Favorite = favoriteState;
  notify({
    message,
    width: 450,
  },
  favoriteState ? 'success' : 'error', 2000);
}
</script>
<style src="./styles.css"></style>
