<!DOCTYPE html>
<html lang="en">

<head>
    <title>DevExtreme jQuery Example</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script type="text/javascript">
        const currentThemeId = localStorage.getItem("currentThemeId") || "light";

        const link = document.createElement("link");
        link.href = `../artifacts/css/dx.${currentThemeId}.css`;
        link.type = "text/css";
        link.rel = "stylesheet";

        document.getElementsByTagName("head")[0].appendChild(link);
    </script>

    <script type="text/javascript" src="../artifacts/js/jquery.js"></script>
    <!-- HtmlEditor -->
    <script type="text/javascript" src="../artifacts/js/dx-quill.min.js"></script>

    <script type="module">
        import { unified } from 'https://esm.sh/unified@11?bundle';
        import remarkParse from 'https://esm.sh/remark-parse@11?bundle';
        import remarkGfm from 'https://esm.sh/remark-gfm@4?bundle';
        import remarkRehype from 'https://esm.sh/remark-rehype@11?bundle';
        import rehypeStringify from 'https://esm.sh/rehype-stringify@10?bundle';
        import remarkGithub from 'https://esm.sh/remark-github@12?bundle';
        import rehypeParse from 'https://esm.sh/rehype-parse@9?bundle';
        import rehypeRemark from 'https://esm.sh/rehype-remark@10?bundle';
        import remarkStringify from 'https://esm.sh/remark-stringify@11?bundle';
        import rehypeRaw from 'https://esm.sh/rehype-raw@7?bundle';

        window.unified = unified;
        window.remarkParse = remarkParse;
        window.remarkGfm = remarkGfm;
        window.remarkGithub = remarkGithub;
        window.remarkRehype = remarkRehype;
        window.rehypeStringify = rehypeStringify;
        window.rehypeParse = rehypeParse;
        window.rehypeRemark = rehypeRemark;
        window.remarkStringify = remarkStringify;
        window.rehypeRaw = rehypeRaw;
    </script>

    <script src="https://unpkg.com/turndown@7.1.2/dist/turndown.js"></script>
    <script src="https://unpkg.com/showdown@2.1.0/dist/showdown.js"></script>

    <script type="text/javascript" src="../artifacts/js/cldr.js"></script>
    <script type="text/javascript" src="../artifacts/js/cldr/event.js"></script>
    <script type="text/javascript" src="../artifacts/js/cldr/supplemental.js"></script>
    <script type="text/javascript" src="../artifacts/js/cldr/unresolved.js"></script>
    <script type="text/javascript" src="../artifacts/js/globalize.js"></script>
    <script type="text/javascript" src="../artifacts/js/globalize/message.js"></script>
    <script type="text/javascript" src="../artifacts/js/globalize/number.js"></script>
    <script type="text/javascript" src="../artifacts/js/globalize/currency.js"></script>
    <script type="text/javascript" src="../artifacts/js/globalize/date.js"></script>


    <script type="text/javascript" src="../artifacts/js/exceljs.min.js"></script>
    <script type="text/javascript" src="../artifacts/js/FileSaver.min.js"></script>
    <script type="text/javascript" src="../artifacts/js/jszip.min.js"></script>
    <script type="text/javascript" src="../artifacts/js/jspdf.umd.min.js"></script>
    <script type="text/javascript" src="../artifacts/js/jspdf.plugin.autotable.min.js"></script>


    <script type="text/javascript" src="../artifacts/js/dx.all.debug.js" charset="utf-8"></script>
    <script type="text/javascript" src="./themeSelector.js"></script>
    <script type="text/javascript" src="../../../node_modules/axe-core/axe.min.js"></script>
</head>

<body class="dx-surface">
    <div role="main">
        <h1 style="position: fixed; left: 0; top: 0; clip: rect(1px, 1px, 1px, 1px);">Test header</h1>

        <select id="theme-selector" style="display: block;">
        </select>
        <br />

        <label>
            <input type="checkbox" id="checkbox" checked>
            Use Unified?
        </label>

        <br />
        <br />

        <div class="dx-viewport demo-container">
            <div class="html-editor"></div>
        </div>


        <script>
            $(() => {
                const checkbox = document.getElementById('checkbox');

                class UnifiedMarkdownConverter {
                    constructor(repositoryUrl = 'https://github.com/DevExpress/DevExtreme/') {
                        this.repositoryUrl = repositoryUrl;
                    }

                    toHtml(value) {
                        const result = window.unified()
                            .use(window.remarkParse)
                            .use(window.remarkGfm)
                            .use(window.remarkGithub, { repository: this.repositoryUrl })
                            .use(window.remarkRehype)
                            .use(window.rehypeStringify)
                            .processSync(value);

                        return result.value;
                    }

                    fromHtml(value) {
                        const markup = value.replace(/<code>\s*<a href="([^"]+)"[^>]*>([^<]+)<\/a>\s*<\/code>/g, '`[$2]($1)`');

                        const result = window.unified()
                            .use(window.rehypeParse, { fragment: true })
                            .use(window.rehypeRaw)
                            .use(window.rehypeRemark)
                            .use(window.remarkStringify)
                            .processSync(markup);

                        return result.value;
                    }
                }

                class ShowdownTurndownMarkdownConverter {
                    constructor() {
                        const turndown = TurndownService;
                        const showdown = window.showdown;

                        this.turndown = new turndown();

                        this.turndown.addRule('emptyLine', {
                            filter: (element) => element.nodeName.toLowerCase() === 'p' && element.innerHTML === '<br>',
                            replacement() {
                                return '<br>';
                            },
                        });

                        this.turndown.keep(['table']);

                        this.showdown = new showdown.Converter({
                            simpleLineBreaks: true,
                            strikethrough: true,
                            tables: true,
                        });
                    }

                    toHtml(value) {
                        let markup = this.showdown.makeHtml(value);

                        if (markup) {
                            markup = markup.replace(new RegExp('\\r?\\n', 'g'), '');
                        }

                        return markup;
                    }

                    fromHtml(value) {
                        const result = this.turndown.turndown(value || '');

                        return result;
                    }
                }

                const unifiedConverter = new UnifiedMarkdownConverter();
                const showdownTurndownConverter = new ShowdownTurndownMarkdownConverter();

                const useUnified = true;

                const converter = useUnified ? unifiedConverter : showdownTurndownConverter;

                const editorInstance = $('.html-editor').dxHtmlEditor({
                    height: 300,
                    converter,
                    onValueChanged: (e) => {
                        // debugger;
                    },
                }).dxHtmlEditor('instance');

                const setValue = (useUnified) => {
                    if (useUnified) {
                        editorInstance.option({ value: 'Commit: f603d5534f876a18a6cf553b7a03b47208adf5b5' });
                    } else {
                        editorInstance.option({ value: '| Month    | Savings |\n| -------- | ------- |\n| January  | $250    |\n| February | $80     |\n| March    | $420    |\n' });
                    }
                }

                checkbox.addEventListener('change', () => {
                    const { checked } = checkbox;

                    editorInstance.option({ converter: checked ? unifiedConverter : showdownTurndownConverter });

                    setValue(checked);
                });

                setValue(useUnified);
            });
        </script>
    </div>
</body>
</html>
