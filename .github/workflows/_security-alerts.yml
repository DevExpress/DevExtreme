name: Send dependabot new vulnerability alerts

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    name: Fetch analysis
    outputs:
      alerts: ${{ steps.fetch.outputs.ALERTS }}

    steps:
      - id: fetch
        name: Get Latest Analysis info
        run: |
          RESPONSE=$(curl \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/dependabot/alerts?state=open)
          echo 'ALERTS<<EOF' >> $GITHUB_OUTPUT
          echo $RESPONSE >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

  notify:
    runs-on: ubuntu-latest
    name: Send notifications
    needs: [ fetch ]

    steps:
      - name: Get Date
        id: get-date
        run: |
          echo "::set-output name=date::$(/bin/date -u "+%s")"
        shell: bash

      - uses: actions/cache@v3
        id: notify-cache
        with:
          path: dependabot_alerts.json
          key: ${{ runner.os }}-security-${{ steps.get-date.outputs.date }}
          restore-keys: ${{ runner.os }}-security

      - name: Teams Notification
        uses: DevExpress/github-actions/send-teams-notification@main
        with:
          hook_url: ${{ secrets.TEAMS_SECURITY_ALERTS }}
          alerts: ${{ needs.fetch.outputs.alerts }}
          alert_type: Dependabot
          alerts_cache_file: dependabot_alerts.json
